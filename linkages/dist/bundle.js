(()=>{"use strict";function t(t,e){return Math.hypot(t.x-e.x,t.y-e.y)}function e(e,n,r,s){if("string"==typeof r)return[r,n[r]];if(0===e.length)return null;let a=e[0],o=n[a],i=t(o,r);for(const s of e){const e=n[s],p=t(e,r);p<i&&(i=p,a=s,o=e)}return i<s?[a,o]:null}function n(t,e,[n,r]){const{x:s,y:a}="string"==typeof e?t[e]:e,{x:o,y:i}=t[n],{x:p,y:c}=t[r],l=(p-o)**2+(c-i)**2;if(0===l)return Math.sqrt((s-o)**2+(a-i)**2);let y=((s-o)*(p-o)+(a-i)*(c-i))/l;y=Math.max(0,Math.min(1,y));const u=o+y*(p-o),f=i+y*(c-i);return{distance:Math.sqrt((s-u)**2+(a-f)**2),closestX:u,closestY:f}}function r({x:t,y:e},{x:n,y:r},{x:s,y:a},o,{l0:i,l1:p}){if(null==i)i=Math.sqrt(s**2+a**2);else{if(null!=p)throw new Error("either l0 or l1 must be provided");p=Math.sqrt((o-s)**2+a**2)}const c=n-t,l=r-e,y=Math.sqrt(c**2+l**2);if(y>i+p||i>y+p||p>y+i)throw new Error("lengths don't make a triangle");return{pt:{x:s=(y**2+i**2-p**2)/(2*y),y:a=(a>0?1:-1)*Math.sqrt(i**2-s**2)},l2t:y}}function s({x:t,y:e},{x:n,y:r},{x:s,y:a}){const o=n-t,i=r-e,p=Math.sqrt(o**2+i**2),c=o/p,l=-i/p,y=s-t,u=a-e;return{pt:{x:y*c-u*l,y:y*l+u*c},l2t:p}}function a({x:t,y:e},{x:n,y:r},{x:s,y:a},o){const i=Math.sqrt(s**2+a**2),p=Math.sqrt((o-s)**2+a**2),c=n-t,l=r-e,y=Math.sqrt(c**2+l**2);if(y>i+p||i>y+p||p>y+i)throw new Error("lengths don't make a triangle");const u=c/y,f=l/y;return{x:t+(s=(y**2+i**2-p**2)/(2*y))*u-(a=(a>0?1:-1)*Math.sqrt(i**2-s**2))*f,y:e+s*f+a*u}}function o({x:e,y:n},{x:r,y:s},a){const o=Math.atan2(s-n,r-e),i={x:e+a*Math.cos(o),y:n+a*Math.sin(o)};if(t(i,{x:e,y:n})<t({x:r,y:s},{x:e,y:n}))throw new Error("slider is over extended");return i}function i(t,e,n){const r={x:t.x-e.x,y:t.y-e.y},s={x:n.x-t.x,y:n.y-t.y},a=function(t){const e=Math.sqrt(t.x**2+t.y**2);return{x:t.x/e,y:t.y/e}}(r),o=function(t,e){return t.x*e.x+t.y*e.y}(s,a);return{x:t.x+o*a.x,y:t.y+o*a.y}}function p(t,e){const n={};for(const e of Object.keys(t.params))e.startsWith("p")&&(n[e]=t.params[e]);for(const r of t.links)switch(r.type){case"rotary":{const s=n[r.p0],a=t.params[r.len],o=t.params[r.theta];n[r.p1]={x:Math.cos(e+o)*a+s.x,y:Math.sin(e+o)*a+s.y};break}case"hinge":{const e=n[r.p0],s=n[r.p1],o=n[r.pt],i=t.params[r.l2t];n[r.p2]=a(e,s,o,i);break}case"slider":{const e=n[r.p0],s=n[r.p1],a=t.params[r.len];n[r.p2]=o(e,s,a);break}}return n}function c(t,e=100){const n=new Set;for(const e of Object.keys(t.params))e.startsWith("p")&&n.add(e);const r={};let s=0,a=!1;function o(o){const i=o/e*2*Math.PI;let c=null;try{c=p(t,i)}catch(t){return void(a&&(s+=1,a=!1))}a=!0;for(const t of Object.keys(c))n.has(t)||(t in r||(r[t]=[]),s in r[t]||(r[t][s]=[]),r[t][s].push(c[t]))}for(let t=0;t<e;t++)o(t);return o(0),r}function l(t,e,n){t[0][2]+=e,t[1][2]+=n}function y(t,e,n){t[0][0]*=e,t[0][1]*=e,t[0][2]*=e,t[1][0]*=n,t[1][1]*=n,t[1][2]*=n}function u(t,{x:e,y:n}){const[[r,s,a],[o,i,p],[c,l,y]]=t,u=r*(i*y)-s*(o*y);if(0===u)throw new Error("Matrix is singular and cannot be inverted.");const f=[[i*y,-s*y,s*p-a*i],[-o*y,r*y,a*o-r*p],[0,0,r*i-s*o]];return{x:(f[0][0]*e+f[0][1]*n+f[0][2])/u,y:(f[1][0]*e+f[1][1]*n+f[1][2])/u}}function f(t,{x:e,y:n}){return{x:t[0][0]*e+t[0][1]*n+t[0][2],y:t[1][0]*e+t[1][1]*n+t[1][2]}}function h(t,e,n,r){function s(t,e){return t.x*e.y-t.y*e.x}function a(t,e){return{x:t.x-e.x,y:t.y-e.y}}function o(t,e,n){return Math.min(t,e)<=n&&n<=Math.max(t,e)}function i(t,e,n){return o(t.x,e.x,n.x)&&o(t.y,e.y,n.y)}let p=s(a(e,t),a(n,t)),c=s(a(e,t),a(r,t)),l=s(a(r,n),a(t,n)),y=s(a(r,n),a(e,n));return p*c<0&&l*y<0||0===p&&i(t,e,n)||0===c&&i(t,e,r)||0===l&&i(n,r,t)||0===y&&i(n,r,e)}function d(t,e,n){for(const[r,s]of t)for(const[t,a]of e)if(h(...[r,s,t,a].map(t=>n[t])))return!0;return!1}function g(t,e,n,r){for(const[s,a]of t.entries())if(s===e)for(const t of a){const e=[...t].map(t=>r.get(t)).filter(t=>null!=t),s=Math.min(...e),a=Math.max(...e);if(s<n&&n<a)return!0}else{const t=r.get(s);if(null==t)continue;for(const s of a){if(!s.has(e))continue;const a=[...s].map(t=>t===e?n:r.get(t)).filter(t=>null!=t),o=Math.min(...a),i=Math.max(...a);if(o<t&&t<i)return!0}}return!1}function m(t){const e=t.values();return Math.max(...e)-Math.min(...e)+1}let x=0;function k(t,e,n,r,s,a,o,i,p){if(x+=1,s>=t.length)return i.push(a),m(a);const c=t[s],l=e.get(c),y=n.get(c);let u=p;for(let p=0;p<t.length;p++){const f=new Map(a).set(c,p);m(f)>=u||(o.get(p)??[]).some(t=>l.has(t)||y.has(t))||g(r,c,p,a)||(u=k(t,e,n,r,s+1,f,new Map(o).set(p,(o.get(p)||[]).concat([c])),i,u))}return u}function b(t,e){const n=Array.from(t.keys()),r=n.map(e=>t.get(e)),s=Math.min(...r),a=n.map(t=>e.get(t)),o=Math.min(...a),i=Math.max(...a);return r.every((t,e)=>t-s===a[e]-o)||r.every((t,e)=>t-s===i-a[e])}function w(t,e,n,r){x=0;const s=[],a=k(t,e,n,r,0,new Map,new Map,s,t.length+1),o=new Map(s.map(t=>[t,m(t)])),i=Array.from(o.entries()).filter(([t,e])=>e===a).map(([t])=>t),p=[i[0]];for(let t=1;t<i.length;t++){const e=i[t];let n=!1;for(let r=0;r<t;r++)if(b(e,i[r])){n=!0;break}n||p.push(e)}return p}function M(t){const e=new Set;for(const n of t.links)switch(n.type){case"rotary":e.add(n.p0).add(n.p1);break;case"hinge":case"slider":e.add(n.p0).add(n.p1).add(n.p2)}return Array.from(e)}function v(t){const e=[];for(const n of t.links)switch(n.type){case"rotary":e.push([n.p0,n.p1]);break;case"hinge":e.push([n.p0,n.p2]),e.push([n.p1,n.p2]);break;case"slider":e.push([n.p0,n.p2])}return e}function S(t,e,n,r,a,o){const i="pt"+t.n++,p="l2t"+t.n++,c="p"+t.n++;t.links.push({type:"hinge",p0:n,p1:r,pt:i,l2t:p,p2:c});const l=e[n],{pt:y,l2t:u}=s(l,a,o);return t.params[i]=y,t.params[p]=u,{type:"init"}}function E(t,e){return t.links.filter(t=>t.p0===e||t.p1===e||t.p2===e)}function A({p0:t,p1:e,xy:n}){if(null!=t&&null!=e){const n=[t,e];return n.sort(),`param-len-${n[0]}-${n[1]}`}return`param-ground-${t}-${n}`}function T(t,e,n,s,a){const{p0:o,p1:i}=function(t){return t.match(/^param-len-(?<p0>[^-]+)-(?<p1>[^-]+)$/).groups}(s);for(const o of t.links)switch(o.type){case"rotary":if(s===A({p0:o.p0,p1:o.p1})){const n=t.params[o.len];t.params[o.len]=a;try{p(t,e)}catch(e){t.params[o.len]=n}return}break;case"slider":if(s===A({p0:o.p0,p1:o.p2})){const n=t.params[o.len];t.params[o.len]=a;try{p(t,e)}catch(e){t.params[o.len]=n}return}break;case"hinge":if(s===A({p0:o.p0,p1:o.p2})){const s=t.params[o.pt],i=t.params[o.l2t],{pt:c,l2t:l}=r(n[o.p0],n[o.p1],s,i,{l0:a});t.params[o.pt]=c,t.params[o.l2t]=l;try{p(t,e)}catch(e){t.params[o.pt]=s,t.params[o.l2t]=i}return}if(s===A({p0:o.p1,p1:o.p2})){const s=t.params[o.pt],i=t.params[o.l2t],{pt:c,l2t:l}=r(n[o.p0],n[o.p1],s,i,{l1:a});t.params[o.pt]=c,t.params[o.l2t]=l;try{p(t,e)}catch(e){t.params[o.pt]=s,t.params[o.l2t]=i}return}}throw new Error("couldnt find link owner")}function $(t,e,n,r){const{p0:s,xy:a}=n.match(/^param-ground-(?<p0>[^-]+)-(?<xy>[xy])$/).groups,o=t.params[s],i={...o};"x"==a?o.x=r:o.y=r;try{p(t,e)}catch(e){t.params[s]=i}}function I(t,e,n,r,s){return S(t,e,n,r,e[r],s)}function L(t,e,n,r,s){const a="p"+t.n++;return t.params[a]=r,S(t,e,n,a,r,s)}function P(e,n,r,s){switch(console.log(e,n,r),e.type){case"init":return"d"===n.type?"string"==typeof n.p0?function(t,e){const n=E(t,e);if(n.length>1)return{type:"init"};const r=n[0];switch(r.type){case"rotary":if(E(t,r.p1).length>1)return{type:"init"};delete t.params[r.p1],1===E(t,r.p0).length&&delete t.params[r.p0],delete t.params[r.len],delete t.params[r.theta];break;case"hinge":if(E(t,r.p2).length>1)return{type:"init"};delete t.params[r.p2],1===E(t,r.p0).length&&delete t.params[r.p0],1===E(t,r.p1).length&&delete t.params[r.p1],delete t.params[r.pt],delete t.params[r.l2t]}const s=t.links.indexOf(r);return t.links=[...t.links.slice(0,s),...t.links.slice(s+1)],{type:"init"}}(r,n.p0):e:n;case"p":switch(n.type){case"p":return{type:"pp",p0:e.p0,p1:n.p0};case"g":return{type:"pg",p0:e.p0,p1:n.p0};default:return e}case"r":return"g"===n.type?function(t,e){const n="p"+t.n++,r="p"+t.n++,s="len"+t.n++,a="theta"+t.n++;return t.params[n]=e,t.params[s]=1,t.params[a]=0,t.links.push({type:"rotary",p0:n,p1:r,len:s,theta:a}),{type:"init"}}(r,n.p0):e;case"g":switch(n.type){case"p":return{type:"gp",p0:e.p0,p1:n.p0};case"g":return{type:"gg",p0:e.p0,p1:n.p0};case"pp":return I(r,s,n.p0,n.p1,e.p0);default:return e}case"pg":switch(n.type){case"p":return I(r,s,e.p0,n.p0,e.p1);case"g":return L(r,s,e.p0,n.p0,e.p1);default:return e}case"gp":return"g"===n.type?L(r,s,e.p1,e.p0,n.p0):e;case"gg":return"p"===n.type?L(r,s,n.p0,e.p0,e.p1):e;case"pp":return"g"===n.type?I(r,s,e.p0,e.p1,n.p0):e;case"slider":switch(n.type){case"p":return{type:"slider_p",p0:n.p0};case"g":return{type:"slider_g",p0:n.p0};default:return e}case"slider_g":return"p"===n.type?{type:"slider_gp",p0:e.p0,p1:n.p0}:e;case"slider_p":switch(n.type){case"p":return{type:"slider_pp",p0:e.p0,p1:n.p0};case"g":return{type:"slider_pg",p0:e.p0,p1:n.p0};default:return e}case"slider_pp":case"slider_pg":case"slider_gp":return"g"===n.type?function(e,n,r,s){let{p0:a,p1:o}=r;const p="string"==typeof a?n[a]:a,c="string"==typeof o?n[o]:o,l=t(p,i(p,c,s));if(l<t(p,c))return r;const y="len"+e.n++,u="string"==typeof a?a:"p"+e.n++,f="string"==typeof o?o:"p"+e.n++,h="p"+e.n++;return e.links.push({type:"slider",p0:u,p1:f,len:y,p2:h}),"string"!=typeof a?e.params[u]=a:a=p,"string"!=typeof o?e.params[f]=o:o=c,e.params[y]=l,{type:"init"}}(r,s,e,n.p0):e;default:return console.warn("unknown state/action",e,n),e}}const q=.15;let C,O;function D(t,e,n,r="black",s=!0){const a="string"==typeof e?t[e]:e,o="string"==typeof n?t[n]:n;if(O.beginPath(),O.strokeStyle=r,O.lineWidth=.075,O.moveTo(a.x,a.y),O.lineTo(o.x,o.y),O.stroke(),s)for(const t of[a,o])O.beginPath(),O.fillStyle=r,O.arc(t.x,t.y,q,0,2*Math.PI),O.fill()}function j(t,e,n="black"){const r=Math.atan2(e.y-t.y,e.x-t.x);O.save(),O.translate(e.x,e.y),O.rotate(r),O.fillStyle=n,O.beginPath(),O.rect(-.15,-.15,.3,.105),O.rect(-.15,.045,.3,.105),O.fill(),O.restore()}const _=["green","blue","yellow","purple","orange","brown","pink","gray","black"];function B(t,e,n,r,s){const a=O.measureText(e).width+20;let o=document.getElementById(t);null==o&&(o=document.createElement("input"),o.type="number",o.step=.1,o.min=0,o.id=t,Object.assign(o.style,{position:"absolute",color:"black",padding:"5px",fontSize:"10px",fontFamily:"sans-serif",zIndex:"1000",width:`${a}px`,background:"lightGray",borderRadius:"5px",border:"1px solid white",boxShadow:"0 0 10px 0 rgba(0, 0, 0, 0.5)",backdropFilter:"blur(10px)"}),document.body.appendChild(o),Object.keys(s).forEach(t=>{o.addEventListener(t,s[t])})),t!==r&&(o.value=Number(e)),o.style.left=n.x-a/2+"px",o.style.top=n.y-10+"px"}const W="http://www.w3.org/2000/svg",R=.25,N=.5,U=t=>Math.round(1e3*t)/1e3,F=(t,e,n,r,s="black",a="none")=>{const o=document.createElementNS(W,"circle");o.setAttribute("cx",`${e}`),o.setAttribute("cy",`${n}`),o.setAttribute("r",`${r}`),o.setAttribute("stroke",s),o.setAttribute("fill",a),t.appendChild(o)},H=(t,e=0,n=0,r)=>{const s=document.createElementNS(W,"polygon"),a=r.map(([t,r])=>`${U(t+e)},${U(-r+n)}`).join(" ");s.setAttribute("points",a),s.setAttribute("stroke","black"),s.setAttribute("fill","none"),t.appendChild(s)};function X(t,e,n,{outterDiam:r,materialThickness:s}){F(t,e,n,r/2);const a=(s-R)/2,o=(3*s-R)/2;H(t,e,n,[[a,o],[a,a],[o,a],[o,-a],[a,-a],[a,-o],[-a,-o],[-a,-a],[-o,-a],[-o,a],[-a,a],[-a,o]])}function Y(t,e,n,{outterDiam:r,innerDiam:s}){F(t,e,n,r/2),F(t,e,n,(s+N-R)/2,"red")}function z(t,e,n,r,{materialThickness:s}){const a=(3*s+R)/2,o=(3*r*s+R)/2,i=(s-R)/2,p=o-R/2;H(t,e,n+o,[[a,o],[a,-o],[-a,-o],[-a,o],[-i,o],[-i,o-p],[i,o-p],[i,o]])}const G=(e,n,r,s,a,o,{innerDiam:i,outterDiam:p})=>{const c=40*t(s,a),l=40*t(a,o),y=40*t(s,o),u=Math.acos((y**2-c**2-l**2)/(-2*c*l));!function(t,e,n){if(e.length<3)throw new Error("A polygon requires at least 3 points.");const r=document.createElementNS("http://www.w3.org/2000/svg","path"),s=e.length;let a="";function o(t,e){return{x:e.x-t.x,y:e.y-t.y}}function i(t){const e=Math.hypot(t.x,t.y);return{x:t.x/e,y:t.y/e}}function p(t,e){return{x:t.x*e,y:t.y*e}}function c(t,e){return{x:t.x+e.x,y:t.y+e.y}}function l(t,e,n){const r=(t,e)=>Math.hypot(t.x-e.x,t.y-e.y),s=40*r(t,e),a=40*r(e,n),o=40*r(t,n);return Math.acos((o**2-s**2-a**2)/(-2*s*a))}for(let t=0;t<s;t++){const r=e[(t-1+s)%s],y=e[t],u=e[(t+1)%s],f=l(r,y,u);Math.tan((Math.PI-f)/2);let h=i(o(y,u));h={x:h.y,y:-h.x};let d=c(y,p(h,n/2)),g=i(o(y,r));g={x:-g.y,y:g.x};let m=c(y,p(g,n/2));a+=0===t?`M ${m.x} ${m.y} `:`L ${m.x} ${m.y} `,a+=`A ${n/2} ${n/2} 0 0 1 ${d.x} ${d.y} `}a+="Z",r.setAttribute("d",a),r.setAttribute("stroke","black"),r.setAttribute("fill","none"),t.appendChild(r)}(e,[s={x:n,y:r},a={x:n+c,y:r},o={x:n+Math.cos(u)*l,y:r+Math.sin(u)*l}],p);const f=(i+N)/2;return F(e,s.x,s.y,f,"red"),F(e,a.x,a.y,f,"red"),F(e,o.x,o.y,f,"red"),Math.sin(u)*l},J=(t,e,n,r,{innerDiam:s,outterDiam:a})=>{const o=a,i=document.createElementNS(W,"rect");i.setAttribute("x",e-o/2),i.setAttribute("y",n-o/2),i.setAttribute("rx",o/2),i.setAttribute("width",r+o),i.setAttribute("height",o),i.setAttribute("stroke","black"),i.setAttribute("fill","none"),t.appendChild(i),F(t,e,n,(s+N)/2,"red"),F(t,e+r,n,(s+N)/2,"red")},V=t=>t/96*25.4;function K(e,n,r,s,a=3.5){const o=a*Math.sqrt(10),i=2*a+o,p={materialThickness:a,innerDiam:o,outterDiam:i};e.innerHTML="";let c=10;const l=i+a;let y=new Map;const u=(t,e)=>{for(const e of t)y.set(e,(y.get(e)??new Set).add(t))};for(const n of s.planes)for(const s of n)if(s.triangles.length>0)for(const[t,n,a]of s.triangles)u([t,n,a]),c+=l+G(e,10,c,"string"==typeof t?r[t]:t,"string"==typeof n?r[n]:n,"string"==typeof a?r[a]:a,p);else for(const[n,a]of s.segments){u([n,a]);const s=t("string"==typeof n?r[n]:n,"string"==typeof a?r[a]:a);J(e,10,c,40*s,p),c+=l}let f=0;for(const[t,n]of y.entries()){const t=n.size;if(console.log(t),1!==t)for(let n=0;n<2;n++){X(e,f*l+10,0+c,p);for(let n=0;n<t-1;n++)Y(e,f*l+10,(n+1)*l+c,p);z(e,f*l+10,t*l+c-i/2,t,p),f+=1}}}let Z={type:"init"},Q=null,tt=null,et=0,nt=!1,rt=1,st=!1,at=!1,ot=!0;const{ctx:it,canvas:pt}=(C=document.getElementById("canvas"),O=C.getContext("2d"),C.width=window.innerWidth,C.height=window.innerHeight,{ctx:O,canvas:C}),ct=function(){let t=document.getElementById("svgCanvas");const e=V(window.innerWidth),n=V(window.innerHeight);return t.setAttribute("width",e+"mm"),t.setAttribute("height",n+"mm"),t.setAttribute("viewBox",`0 0 ${e} ${n}`),t}(),lt=document.getElementById("svgView"),yt=document.getElementById("materialThickness");yt.addEventListener("input",t=>{K(ct,0,gt,bt,Number(t.target.value))}),console.log(yt,materialThickness);const ut=[[1,0,0],[0,1,0],[0,0,1]],ft=Math.min(pt.width,pt.height);y(ut,ft/10,-ft/10),l(ut,pt.width/2,pt.height/2);const ht=new URLSearchParams(location.search).get("linkage");let dt=null!=ht?JSON.parse(ht):{n:3,params:{p0:{x:0,y:0},len2:1,theta2:0},links:[{type:"rotary",p0:"p0",p1:"p1",len:"len2",theta:"theta2"}]},gt=p(dt,et),mt=!1,xt=null,kt=!1,bt=null;function wt(){(mt||kt||at)&&(xt=c(dt)),(kt||at)&&(bt=function(t,e){const r=function(t){const e=e=>null!=t.params[e],n=[{points:new Set,segments:[],triangles:[],sliders:[]}],r=(t,e,r=!1)=>{t===n.length&&n.push({points:new Set,segments:[],triangles:[],sliders:[]});const s=n[t];1===e.length?s.points.add(e[0]):2===e.length?(s.points.add(e[0]).add(e[1]),s.segments.push(e)):3===e.length&&(e.forEach(t=>s.points.add(t)),r?(s.segments.push([e[0],e[2]]),s.sliders.push(e)):(s.segments.push([e[0],e[1]]),s.segments.push([e[1],e[2]]),s.triangles.push(e)))},s=({p0:t,p1:e})=>n.findIndex(n=>!n.sliders.some(n=>n[1]===t||n[1]===e)&&n.points.has(t)&&n.points.has(e));for(const a of t.links)switch(a.type){case"rotary":e(a.p0)&&r(0,[a.p0]),r(n.length,[a.p0,a.p1]);break;case"hinge":{const t=s(a);-1!=t?r(t,[a.p0,a.p2,a.p1]):(r(n.length,[a.p0,a.p2]),r(n.length,[a.p2,a.p1]),e(a.p0)&&r(0,[a.p0]),e(a.p1)&&r(0,[a.p1]));break}case"slider":{const t=s(a);-1!=t?r(t,[a.p0,a.p1,a.p2],!0):(r(n.length,[a.p0,a.p1,a.p2],!0),e(a.p0)&&r(0,[a.p0]),e(a.p1)&&r(0,[a.p1]));break}}const a=Array.from(n[0].points);for(let t=0;t<a.length-1;t++)r(0,[a[t],a[t+1]]);return n}(t),{plateConnections:s,pointConnections:a}=function(t){const e=new Map(t.map(t=>[t,new Set])),n=new Map;for(let r=0;r<t.length;r++){const s=t[r];for(let a=r+1;a<t.length;a++){const r=t[a];for(const t of s.points)if(r.points.has(t)){e.get(s).add(r),e.get(r).add(s);const a=n.get(t)??new Set;n.set(t,a.add(s).add(r));break}}}return{plateConnections:e,pointConnections:n}}(r),o=function(t,e,n){const r=new Map(t.map(t=>[t,new Set]));for(const s of e)for(let e=0;e<t.length;e++){const a=t[e];for(let o=e+1;o<t.length;o++){const e=t[o];!n.get(a).has(e)&&d(a.segments,e.segments,s)&&(r.get(a).add(e),r.get(e).add(a))}}return r}(r,e,s),i=function(t,e,r,s=.15){const a=new Map;for(const n of t){const t=new Set;for(const[r,s]of e.entries())s.has(n)||t.add(r);a.set(n,t)}const o=new Map(t.map(t=>[t,[]]));for(const t of r)for(const[r,i]of a.entries())for(const a of i)for(const p of r.segments){const{distance:c}=n(t,a,p);if(c<s){o.get(r).push(e.get(a)),i.delete(a);break}}return o}(r,a,e),p=w(r,s,o,i)[0];if(null==p)return console.error("no layering solution found"),null;const c=[];for(const[t,e]of p.entries())null==c[e]&&(c[e]=[]),c[e].push(t);return{planes:c}}(dt,function(t,e){const n={};for(const e of Object.keys(t.params))e.startsWith("p")&&!e.startsWith("pt")&&(n[e]=t.params[e]);const r=[];for(const[t,s]of Object.entries(e)){let e=0;for(const a of s)for(const s of a)r.length<=e&&r.push({...n}),r[e][t]=s,e+=1}return r}(dt,xt)))}function Mt(t){const r=M(dt),s=e(r,gt,t,q)?.[0];Q=s??t,tt=null==s?function(t,e,r){if(0===t.length)return null;const s="string"==typeof r?e[r]:r;let a=t[0],o=n(e,s,a).distance;for(const r of t){const{distance:t}=n(e,s,r);t<o&&(a=r,o=t)}return o<.15?a:null}(v(dt),gt,t):null}pt.addEventListener("mousedown",t=>{if("init"!==Z.type)return;const n={x:t.clientX,y:t.clientY},r=u(ut,n),s=M(dt),a=e(s,gt,r,q)?.[0];Z=a?{type:"dragging",pRef:a,dragged:!1}:{type:"dragging-bg",p0:n,p1:n,dragged:!1}}),pt.addEventListener("mousemove",e=>{const n={x:e.clientX,y:e.clientY},r=u(ut,n);if("dragging"===Z.type)Z.dragged=!0,function(e,n,r,a,o){const i=e.params[a];if(null!=i){const t={...i};try{i.x=o.x,i.y=o.y,p(e,r)}catch(e){i.x=t.x,i.y=t.y}return}const c=e.links.find(t=>"rotary"===t.type&&t.p1===a);if(null!=c){const n=e.params[c.len],s=e.params[c.theta],a=e.params[c.p0],i=t(o,a),l=Math.atan2(o.y-a.y,o.x-a.x);try{e.params[c.len]=i,e.params[c.theta]=(l-r)%(2*Math.PI),p(e,r)}catch(t){e.params[c.len]=n,e.params[c.theta]=s}return}const l=e.links.find(t=>"slider"===t.type&&t.p2===a);if(null!=l){const s=e.params[l.len];try{e.params[l.len]=t(o,n[l.p0]),p(e,r)}catch(t){e.params[l.len]=s}return}const y={};for(const t of e.links.filter(t=>"hinge"===t.type)){if(t.p0!==a&&t.p1!==a&&t.p2!==a)continue;y[t.pt]=e.params[t.pt],y[t.l2t]=e.params[t.l2t];const r=[t.p0,t.p1,t.p2].map(t=>n[t]);t.p0===a?r[0]=o:t.p1===a?r[1]=o:r[2]=o;const{pt:i,l2t:p}=s(...r);e.params[t.pt]=i,e.params[t.l2t]=p}if(0===Object.keys(y).length)throw new Error("Unknown point moved");try{p(e,r)}catch(t){for(const[t,n]of Object.entries(y))e.params[t]=n}}(dt,gt,et,Z.pRef,r),wt();else if("dragging-bg"===Z.type)Z.dragged=!0,l(ut,n.x-Z.p1.x,n.y-Z.p1.y),Z.p1=n;else if("rotating"===Z.type){const t=function({x:t,y:e}){return t-=pt.width/2,e=pt.height/2-e,-Math.atan2(e,t)}(n);if(null!=Z.theta){const e=t-Z.theta;l(ut,-pt.width/2,-pt.height/2),function(t,e){const n=Math.cos(-e),r=Math.sin(-e),[[s,a,o],[i,p,c]]=t;t[0][0]=n*s+r*i,t[0][1]=n*a+r*p,t[0][2]=n*o+r*c,t[1][0]=-r*s+n*i,t[1][1]=-r*a+n*p,t[1][2]=-r*o+n*c}(ut,e),l(ut,pt.width/2,pt.height/2)}else Z.theta0=t;Z.theta=t}else Mt(r)}),pt.addEventListener("click",t=>{if("rotating"===Z.type)return void(Z={type:"init"});if("dragging"===Z.type||"dragging-bg"===Z.type){const{dragged:t}=Z;if(Z={type:"init"},t)return}if(null==Q)return;let e={type:"g",p0:Q};"string"==typeof Q?e={type:"p",p0:Q}:null==tt||"g"!==Z.type&&"init"!==Z.type||(e={type:"pp",p0:tt[0],p1:tt[1]}),Z=P(Z,e,dt,gt),wt(),gt=p(dt,et),Mt(u(ut,{x:t.clientX,y:t.clientY}))});const vt={Backspace:"Reset state",Escape:"Reset state",c:"Toggle direction",d:"Delete selected link, or download an SVG if shown",i:"Add a slider link",r:"Add another rotary link",s:"Save configuration to URL",Shift:"Hold down to rotate the canvas"," ":"Toggle pause",t:"Toggle traces",v:"Toggle laser cuttable SVG",h:"Toggle help menu",l:"Toggle lengths",p:"Toggle colored plates/layers",x:"Center the canvas","+":"Increase rotary speed","-":"Decrease rotary speed",ArrowUp:"Increase length of selected bar",ArrowDown:"Decrease length of selecd bar",Enter:"Set length of bar"},St=document.getElementById("helpMenu");St.style.display=ot?"flex":"none";const Et=document.getElementById("helpMenuKeys"),At=document.getElementById("helpMenuDescs");for(const[t,e]of Object.entries(vt)){vt[t]={desc:e,key:t};const n=document.createElement("div");n.innerHTML=" "===t?"Space":t,Et.appendChild(n);const r=document.createElement("div");r.innerHTML=e,At.appendChild(r)}document.addEventListener("keydown",t=>{switch(t.key){case vt.Backspace.key:case vt.Escape.key:Z={type:"init"};break;case vt.c.key:rt*=-1;break;case vt.d.key:at?function(){const t=document.getElementById("svgCanvas"),e=(new XMLSerializer).serializeToString(t),n=new Blob([e],{type:"image/svg+xml"}),r=URL.createObjectURL(n),s=document.createElement("a");s.href=r,s.download="linkage.svg",document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(r)}():"init"===Z.type&&(Z=P(Z,{type:"d",p0:Q},dt,gt),Q=null,wt());break;case vt.i.key:Z={type:"slider"};break;case vt.r.key:Z={type:"r"};break;case vt.s.key:location.search=new URLSearchParams({linkage:JSON.stringify(dt)}).toString();break;case vt.Shift.key:Z={type:"rotating",theta:null,theta0:null};break;case vt[" "].key:nt=!nt;break;case vt.t.key:mt=!mt,wt();break;case vt.v.key:at=!at,at?(wt(),pt.style.display="none",lt.style.display="block"):(pt.style.display="block",lt.style.display="none",requestAnimationFrame(Lt));break;case vt.h.key:ot=!ot,St.style.display=ot?"flex":"none";break;case vt.l.key:st=!st,st||function(){for(const t of document.querySelectorAll("input"))t.id.startsWith("param-")&&t.remove()}();break;case vt.p.key:kt=!kt,wt();break;case vt.x.key:{xt=c(dt);const t=Object.values(xt).flat(),e=t.flatMap(t=>t.map(t=>t.x)),n=t.flatMap(t=>t.map(t=>t.y)),r=Math.min(...e),s=Math.max(...e),a=Math.min(...n),o=Math.max(...n),i=f(ut,{x:(r+s)/2,y:(a+o)/2});l(ut,pt.width/2-i.x,pt.height/2-i.y);break}case vt["+"].key:rt*=1.1;break;case vt["-"].key:rt*=.9;break;default:console.log(t.key)}}),document.addEventListener("keyup",t=>{t.key===vt.Shift.key&&(Z={type:"init"})}),document.addEventListener("mousewheel",t=>{const e=t.wheelDeltaY<0?1/1.01:1.01,n=t.clientX,r=t.clientY;l(ut,-n,-r),y(ut,e,e),l(ut,n,r)});let Tt=null;const $t={focus(t){Tt=t.target.id},blur(t){Tt=null},keydown(t){if(t.target.id!==Tt)return;const e=Number(t.target.value);switch(t.key){case vt.Escape.key:t.target.blur();break;case vt.Enter.key:Tt.startsWith("param-len-")?T(dt,et,gt,Tt,e):$(dt,et,Tt,e),wt(),t.target.blur();break;case vt.ArrowUp.key:case vt.ArrowDown.key:Tt.startsWith("param-len-")?T(dt,et,gt,Tt,e):$(dt,et,Tt,e),wt()}}};let It=performance.now();function Lt(){const e=performance.now(),n=(nt?0:e-It)/1e3*Math.PI*2*rt;et+=n,It=e;try{gt=p(dt,et)}catch(t){rt=-rt,et-=n,gt=p(dt,et)}at?K(ct,0,gt,bt,Number(yt.value)):(it.resetTransform(),it.clearRect(0,0,pt.width,pt.height),it.setTransform(ut[0][0],ut[1][0],ut[0][1],ut[1][1],ut[0][2],ut[1][2]),kt&&null!=bt?function(t,{planes:e}){let n=0;for(const r of e){const e=_[n++%_.length];for(const n of r){O.fillStyle=e;for(const e of n.triangles){const n=t[e[0]],r=t[e[1]],s=t[e[2]];O.beginPath(),O.moveTo(n.x,n.y),O.lineTo(r.x,r.y),O.lineTo(s.x,s.y),O.closePath(),O.fill()}for(const e of n.sliders)j(t[e[0]],t[e[1]],"black");for(const[e,r]of n.segments)D(t,e,r);O.lineWidth=.0375,O.strokeStyle=e,O.lineJoin="round";for(let[e,r]of n.segments)e=t[e],r=t[r],O.beginPath(),O.moveTo(e.x,e.y),O.lineTo(r.x,r.y),O.stroke()}}}(gt,bt):function(t,e){for(const n of e.links)switch(n.type){case"rotary":D(t,n.p0,n.p1,"black");break;case"hinge":D(t,n.p0,n.p2,"black"),D(t,n.p1,n.p2,"black");break;case"slider":const e=t[n.p0];j(e,t[n.p1]),D(t,e,n.p2,"black")}}(gt,dt),function(t,e,n,r,s,a){switch(n.type){case"init":null!=s&&D(t,s[0],s[1],"gray");break;case"r":const e={x:r.x+Math.cos(a),y:r.y+Math.sin(a)};D(t,r,e,"gray");break;case"p":case"slider_g":case"slider_p":D(t,n.p0,r,"gray");break;case"g":null!=s?(D(t,n.p0,s[0],"gray"),D(t,n.p0,s[1],"gray")):D(t,n.p0,r,"gray");break;case"pg":case"gg":D(t,n.p0,n.p1,"gray"),D(t,n.p1,r,"gray");break;case"pp":case"gp":D(t,n.p0,r,"gray"),D(t,n.p1,r,"gray");break;case"slider":null!=r&&(O.fillStyle="gray",O.beginPath(),O.arc(r.x,r.y,q,0,2*Math.PI),O.fill());break;case"slider_pg":case"slider_pp":case"slider_gp":{const e="string"==typeof n.p0?t[n.p0]:n.p0,s="string"==typeof n.p1?t[n.p1]:n.p1;j(e,s),D(t,e,i(e,s,r),"gray");break}case"rotating":if(null!=n.theta){O.save(),O.resetTransform();const t=C.width/4,e={x:C.width/2,y:C.height/2},r=(e.x,e.y,{x:e.x+t*Math.cos(n.theta),y:e.y+t*Math.sin(n.theta)});O.lineWidth=2,O.strokeStyle="gray",O.beginPath(),O.moveTo(e.x,e.y),O.lineTo(r.x,r.y),O.stroke(),O.beginPath(),O.arc(e.x,e.y,t,n.theta0,n.theta,n.theta0>n.theta),O.stroke(),O.restore()}}if("string"==typeof r){const n=t[r],s=e.links.find(t=>"slider"===t.type&&t.p1===r);O.fillStyle="lightGray",null!=s?j(t[s.p0],n,"lightGray"):(O.beginPath(),O.arc(n.x,n.y,q,0,2*Math.PI),O.fill())}}(gt,dt,Z,Q,tt,et),mt&&function(t,e){for(const[n,r]of Object.entries(t)){O.strokeStyle=n===e?"red":"gray",O.lineWidth=q/(n===e?4:8);for(const t of r){O.beginPath(),O.moveTo(t[0].x,t[0].y);for(let e=1;e<t.length;e++)O.lineTo(t[e].x,t[e].y);O.stroke()}}}(xt,Q),st&&function(e,n,r,s,a){const o=new Set,i=v(e);for(const[e,p]of i){const i=n[e],c=n[p],l=f(a,{x:(i.x+c.x)/2,y:(i.y+c.y)/2}),y=t(i,c).toFixed(2),u=A({p0:e,p1:p});o.add(u),B(u,y,l,s,r)}for(const t of function(t){const e=new Set;for(const n of t.links)for(const r of[n.p0,n.p1,n.p2].filter(Boolean))null!=t.params[r]&&e.add(r);return Array.from(e)}(e)){const n=e.params[t],i=f(a,n);let{x:p,y:c}=n;p=p.toFixed(2);const l=O.measureText(p).width+35,y=A({p0:t,xy:"x"});B(y,p,{x:i.x-l/2-5,y:i.y+20},s,r);const u=A({p0:t,xy:"y"});B(u,c.toFixed(2),{x:i.x+l/2-5,y:i.y+20},s,r),o.add(y).add(u)}for(const t of document.querySelectorAll("input")){const e=t.id;e.startsWith("param-")&&!o.has(e)&&t.remove()}}(dt,gt,$t,Tt,ut),requestAnimationFrame(Lt))}requestAnimationFrame(Lt)})();